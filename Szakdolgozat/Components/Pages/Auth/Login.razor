@page "/login"
@inject Services.SimpleLoginService LoginService
@inject Services.UserSession Session
@inject NavigationManager Nav
@layout AuthLayout
@inject Services.LogService LogService
@inject IHttpContextAccessor Http



<div class="login-page">
    <div class="login-container">

        <h3 class="login-title">Szakdolgozat</h3>

        <input placeholder="Felhasználónév"
               @bind="username"
               @bind:event="oninput"
               @onkeydown="HandleKey" />

        <input placeholder="Jelszó"
               type="password"
               @bind="password"
               @bind:event="oninput"
               @onkeydown="HandleKey" />



        <button type="button" @onclick="DoLogin">Bejelentkezés</button>

        @if (!string.IsNullOrEmpty(error))
        {
            <p class="login-error">@error</p>
        }
    </div>
</div>

@code {
    string username = "";
    string password = "";
    string error = "";

    async Task DoLogin()
    {
        error = "";

        var user = await LoginService.LoginAsync(username, password);

        if (user == null)
        {
            error = "Invalid username or password";
            return;
        }

        Session.Login(user);

        var ip = Http.HttpContext?.Connection?.RemoteIpAddress?.ToString();
        await LogService.AddLogAsync(
            user.UserCode,
            "LOGIN",
            "Felhasználó belépett",
            page: "/login",
            ipAddress: ip
        );

        Nav.NavigateTo("/");

    }

    async Task HandleKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await DoLogin();
        }
    }

}
