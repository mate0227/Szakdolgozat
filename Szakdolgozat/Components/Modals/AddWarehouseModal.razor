@using Szakdolgozat.Models

<div class="modal-overlay">
    <div class="modal-window">
        <h3>Új raktár</h3>

        <div class="form-row">
            <label>Kód</label>
            <input @bind="Code" class="@GetCodeInputClass()" />

            @if (ShowErrors && string.IsNullOrWhiteSpace(Code))
            {
                <p class="field-error">A kód kitöltése kötelező!</p>
            }
            @if (!string.IsNullOrWhiteSpace(CodeError))
            {
                <p class="field-error">@CodeError</p>
            }
        </div>

        <div class="form-row">
            <label>Név</label>
            <input @bind="Name" class="@GetInputClass(Name)" />
            @if (ShowErrors && string.IsNullOrWhiteSpace(Name))
            {
                <p class="field-error">A név kitöltése kötelező!</p>
            }
        </div>

        <div class="form-row checkbox-row">
            <label>
                <input type="checkbox" @bind="IsAutomaton" />
                Automata
            </label>
        </div>

        <div class="form-row">
            <label>Megye</label>
            <input @bind="County" class="@GetLocationInputClass(County)" />
            @if (ShowErrors && IsAutomaton && string.IsNullOrWhiteSpace(County))
            {
                <p class="field-error">Automatánál a megye kötelező!</p>
            }
        </div>

        <div class="form-row">
            <label>Város</label>
            <input @bind="City" class="@GetLocationInputClass(City)" />
            @if (ShowErrors && IsAutomaton && string.IsNullOrWhiteSpace(City))
            {
                <p class="field-error">Automatánál a város kötelező!</p>
            }
        </div>

        <div class="form-row">
            <label>Irányítószám</label>
            <input @bind="PostalCode" class="@GetLocationInputClass(PostalCode)" />
            @if (ShowErrors && IsAutomaton && string.IsNullOrWhiteSpace(PostalCode))
            {
                <p class="field-error">Automatánál az irányítószám kötelező!</p>
            }
        </div>

        <div class="form-row">
            <label>Cím</label>
            <input @bind="Address" class="@GetLocationInputClass(Address)" />
            @if (ShowErrors && IsAutomaton && string.IsNullOrWhiteSpace(Address))
            {
                <p class="field-error">Automatánál a cím kötelező!</p>
            }
        </div>

        <div class="button-row">
            <button class="save-btn" type="button" @onclick="Save">Mentés</button>
            <button class="close-btn" type="button" @onclick="Close">Mégse</button>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<Warehouse> OnSave { get; set; }

    [Parameter] public Func<string, Task<bool>>? CodeExistsAsync { get; set; }

    public bool ShowErrors { get; set; }

    public string Code { get; set; } = "";
    public string Name { get; set; } = "";
    public bool IsAutomaton { get; set; }

    public string County { get; set; } = "";
    public string City { get; set; } = "";
    public string PostalCode { get; set; } = "";
    public string Address { get; set; } = "";

    public string? CodeError { get; set; }

    private Task Close() => OnClose.InvokeAsync();

    private async Task Save()
    {
        ShowErrors = true;
        CodeError = null;

        var needsLocation = IsAutomaton;

        if (string.IsNullOrWhiteSpace(Code) ||
            string.IsNullOrWhiteSpace(Name) ||
            (needsLocation && (
                string.IsNullOrWhiteSpace(County) ||
                string.IsNullOrWhiteSpace(City) ||
                string.IsNullOrWhiteSpace(PostalCode) ||
                string.IsNullOrWhiteSpace(Address)
            )))
            return;

        if (CodeExistsAsync != null)
        {
            var exists = await CodeExistsAsync(Code.Trim());
            if (exists)
            {
                CodeError = "Már létezik ilyen kód!";
                return;
            }
        }

        await OnSave.InvokeAsync(new Warehouse
        {
            Code = Code.Trim(),
            Name = Name.Trim(),
            IsAutomaton = IsAutomaton,
            County = County.Trim(),
            City = City.Trim(),
            PostalCode = PostalCode.Trim(),
            Address = Address.Trim()
        });
    }

    private string GetCodeInputClass()
    {
        if (!ShowErrors) return "";
        if (!string.IsNullOrWhiteSpace(CodeError)) return "invalid-input";
        if (string.IsNullOrWhiteSpace(Code)) return "invalid-input";
        return "";
    }

    private string GetInputClass(string v)
    {
        if (!ShowErrors) return "";
        return string.IsNullOrWhiteSpace(v) ? "invalid-input" : "";
    }

    private string GetLocationInputClass(string v)
    {
        if (!ShowErrors) return "";
        if (!IsAutomaton) return "";
        return string.IsNullOrWhiteSpace(v) ? "invalid-input" : "";
    }
}
