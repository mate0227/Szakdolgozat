@inject Services.UserSession Session
@inject NavigationManager Nav
@inject Services.LogService LogService
@inject IHttpContextAccessor Http


<header class="home-header">
    <div class="header-left">
        <h3>Home</h3>

        <nav class="menu-bar">

            <div class="menu-dropdown"
                 @onmouseenter=@(() => ShowMenu("torzsek"))
                 @onmouseleave=@(() => ShowMenu(null))>

                <button class="menu-btn" type="button">Törzsek ▾</button>

                <div class="menu-panel @(ActiveMenu == "torzsek" ? "show" : "")">
                    <a class="menu-item" @onclick='() => Nav.NavigateTo("/products")'>Termékek</a>
                    <a class="menu-item" @onclick='() => Nav.NavigateTo("/partners")'>Partnerek</a>
                    <a class="menu-item" @onclick='() => Nav.NavigateTo("/productgroups")'>Termékcsoportok</a>
                    <a class="menu-item" @onclick='() => Nav.NavigateTo("/warehouses")'>Raktárak</a>
                </div>

            </div>

            <div class="menu-dropdown"
                 @onmouseenter=@(() => ShowMenu("keszlet"))
                 @onmouseleave=@(() => ShowMenu(null))>

                <button class="menu-btn" type="button">Készlet ▾</button>

                <div class="menu-panel @(ActiveMenu == "keszlet" ? "show" : "")">
                    <a class="menu-item" @onclick='() => Nav.NavigateTo("/bevetel")'>Bevételezés</a>
                    <a class="menu-item">Átadás</a>
                    <a class="menu-item">Kiadás</a>
                </div>
            </div>

            <div class="menu-dropdown"
                 @onmouseenter=@(() => ShowMenu("kimutatasok"))
                 @onmouseleave=@(() => ShowMenu(null))>

                <button class="menu-btn" type="button">Kimutatások ▾</button>

                <div class="menu-panel @(ActiveMenu == "kimutatasok" ? "show" : "")">
                    <a class="menu-item">Raktárkészlet lista</a>
                    <a class="menu-item">Árak (terméktörzs)</a>
                    <a class="menu-item">Bevételek (összesen / tételesen)</a>
                    <a class="menu-item">Automaták termékei</a>
                </div>
            </div>

        </nav>
    </div>

    @if (Session.IsLoggedIn)
    {
        <div class="user-dropdown"
             @onmouseenter=@(() => ShowDropdown(true))
             @onmouseleave=@(() => ShowDropdown(false))>

            <button class="user-btn" @onclick="ToggleDropdown" type="button">
                @Session.CurrentUser!.Username
                <span class="caret">▾</span>
            </button>

            <div class="dropdown-menu @(_dropdownOpen ? "show" : "")">
                @if (Session.CurrentUser!.RoleName == "Admin")
                {
                    <a class="dropdown-item" @onclick="OpenUserManagement">
                        Felhasználók kezelése
                    </a>
                    <a class="dropdown-item" @onclick="GoToLogs">Logok</a>
                }
                <a class="dropdown-item" @onclick="Logout">Kijelentkezés</a>
            </div>
        </div>
    }
</header>

@if (_showUserModal)
{
    <UserManagementModal OnClose="CloseUserManagement" />
}

@code {
    private bool _dropdownOpen;
    private bool _showUserModal;
    private string? ActiveMenu;

    private void ToggleDropdown() => _dropdownOpen = !_dropdownOpen;
    private void ShowDropdown(bool value) => _dropdownOpen = value;

    private async Task Logout()
    {
        if (Session.CurrentUser is not null)
        {
            var ip = Http.HttpContext?.Connection?.RemoteIpAddress?.ToString();
            await LogService.AddLogAsync(
                Session.CurrentUser.UserCode,
                "LOGOUT",
                "Felhasználó kilépett",
                page: "/logout",
                ipAddress: ip
            );
        }

        Nav.NavigateTo("/logout", true);
    }

    private void GoToLogs() => Nav.NavigateTo("/logs");


    private void OpenUserManagement() => _showUserModal = true;
    private void CloseUserManagement() => _showUserModal = false;

    private void ShowMenu(string? menu) => ActiveMenu = menu;
}
